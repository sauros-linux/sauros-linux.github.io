<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="styles.css"/>
    </head>
    <body>
        <form>
            <fieldset class="container">
                <table class="invisible">
                    <tr>
                        <td colspan="2">
                            <input type="text"      id="name"           name="name" placeholder="Character Name">
                            <label>Character Name</label>
                        </td>
                        <td>
                            <input type="text"      id="player"         name="player" placeholder="Player Name">
                            <label>Player Name</label>
                        </td>
                    </tr>
                </table>
            </fieldset>
            <fieldset class="container">
                <div id="race_container">
                    <table class="invisible">
                        <tr>
                            <td>
                                <input type="text"              id="race"           name="race"         value="" placeholder="Race"
                                    class="chosen-value">
                                <ul class="value-list"          id="race_list"></ul>
                                <label>Race / Species</label>
                            </td>
                        </tr>
                    </table>
                    <p id="race_traits"></p>
                </div>
            </fieldset>
            <fieldset class="container">
                <div id="class_list">
                    <table class="invisible">
                        <tr>
                            <td colspan="6">
                                <input type="text"      id="class1"         name="class1"       value="" placeholder="Class"
                                    class="chosen-value">
                                <ul class="value-list"  id="class1_list"></ul>
                                <label>Class</label>
                            </td>
                            <td colspan="6">
                                <input type="text"      id="class1_sub"     name="class1_sub"   value="" placeholder="Subclass"
                                    class="chosen-value">
                                <ul class="value-list"  id="class1_sub_list"></ul>
                                <label>Subclass</label>
                            </td>
                            <td colspan="2">
                                <input type="text"      id="class1_level"   name="class1_level" value="" placeholder="Level"
                                    class="chosen-value">
                                <ul class="value-list"  id="class1_level_list"></ul>
                                <label>Level</label>
                            </td>
                            <td colspan="2">
                                <input type="text"      id="class1_exp"     name="class1_exp"       placeholder="XP">
                                <label>XP</label>
                            </td>
                        </tr>
                        <tr id="class_control">
                            <td colspan="10"></td>
                            <td colspan="3"><input type="button"    id="add_class"      value="Add Class"/></td>
                            <td colspan="3"><input type="button"    id="remove_class"   value="Remove Class"/></td>
                        </tr>
                    </table>
                    <p id="class_traits"></p>
                </div>
            </fieldset>
            <fieldset class="container">
                <div>
                    <table class="invisible">
                        <tr>
                            <td>
                                <input type="text"      id="background"     name="background"       value="" placeholder="Background"
                                    class="chosen-value">
                                <ul class="value-list"  id="background_list"></ul>
                            </td>
                            <td>
                                <input type="text"      id="alignment"      name="alignment"        value="" placeholder="Alignment"
                                    class="chosen-value">
                                <ul class="value-list"  id="alignment_list">
                                    <li>Lawful Good</li>
                                    <li>Lawful Neutral</li>
                                    <li>Lawful Evil</li>
                                    <li>Neutral Good</li>
                                    <li>True Neutral</li>
                                    <li>Neutral Evil</li>
                                    <li>Chaotic Good</li>
                                    <li>Chaotic Neutral</li>
                                    <li>Chaotic Evil</li>
                                </ul>
                            </td>
                        </tr>
                    </table>
                    <h3>Background</h3>
                    <p>Background Information.</p>
                </div>
            </fieldset>
        </form>

        <script>
            var races = {};
            var race_ids = [];
            var character_race = "";
            var character_class = "";
            var class_num = 1;

            var collapsibles = [];

            window.settings = {
                functionName: "",
            };

            async function getFile(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Response status: ${response.status}`);
                    }

                    return await response;
                } catch (error) {
                    console.error(error.message);
                }
            }

            async function getData(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Response status: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error(error.message);
                }
            }

            function render(str) {
                var result = str;
                var regex = /{@([^}]+)}/g;

                if (typeof str == "string") {
                    var tags = [...result.matchAll(regex)];
                    if (tags.length > 0) {
                        tags.forEach(match => {
                            switch (match[1].split(" ")[0]) {
                                case "skill":
                                    result = result.replace(match[0], "<a>" + match[1].substr(match[1].indexOf(" ") + 1) + "</a>");
                                    break;
                                case "sense":
                                    result = result.replace(match[0], "<a>" + match[1].substr(match[1].indexOf(" ") + 1) + "</a>");
                                    break;
                                case "condition":
                                case "status":
                                    var condition = match[1].substr(match[1].indexOf(" ") + 1);
                                    result = result.replace(match[0], "<a target=\"_blank\" href=\"https://5e.tools/conditionsdiseases.html#" + condition + "_phb\">" + condition + "</a>");
                                    break;
                                case "language":
                                    var condition = match[1].substr(match[1].indexOf(" ") + 1);
                                    result = result.replace(match[0], "<a target=\"_blank\" href=\"https://5e.tools/conditionsdiseases.html#" + condition + "_phb\">" + condition + "</a>");
                                    break;
                                case "item":
                                    var item = match[1].substr(match[1].indexOf(" ") + 1);
                                    var id = item.split("|")[0] + "_" + item.split("|")[1];
                                    result = result.replace(match[0], "<a target=\"_blank\" href=\"https://5e.tools/items.html#" + id + "\">" + item.split("|")[0] + "</a>");
                                    break;
                                case "spell":
                                    var item = match[1].substr(match[1].indexOf(" ") + 1);
                                    var id = item.split("|")[0];
                                    if (item.split("|")[1] != undefined) {
                                        id += "_" + item.split("|")[1];
                                    } else {
                                        id += "_phb";
                                    }
                                    result = result.replace(match[0], "<a target=\"_blank\" href=\"https://5e.tools/spells.html#" + id + "\">" + item.split("|")[0] + "</a>");
                                    break;
                                case "book":
                                    var item = match[1].substr(match[1].indexOf(" ") + 1);
                                    var book = item.split("|")[1];
                                    var chapter = item.split("|")[2];
                                    result = result.replace(match[0], "<a target=\"_blank\" href=\"https://5e.tools/book.html#" + book + "," + chapter + "\">" + item.split("|")[0] + "</a>");
                                    break;
                                case "note":
                                    result = result.replace(match[0], "<span style=\"font-style: italic; color: #777777\">" + match[1].substr(match[1].indexOf(" ") + 1) + "</span>");
                                    break;
                                case "filter":
                                    var item = match[1].substr(match[1].indexOf(" ") + 1);
                                    var text = item.split("|")[0];
                                    var page = item.split("|")[1];

                                    var list = item.split("|");
                                    var filter = "";
                                    for (var i = 2; i < list.length; i++) {
                                        var filter_item = list[i].split("=")[1];
                                        if (filter_item.match(/\[.*\]/g)) {
                                            filter_item = filter_item.replace("[", "").replace("]", "").split(";");
                                            filter += ",flst" + list[i].split("=")[0] + ":min=" + filter_item[0] + "~max=" + filter_item[1];
                                        } else {
                                            filter += ",flst" + list[i].split("=")[0] + ":";
                                            if (filter_item.split(";").length > 1) {
                                                if (Array.from(filter_item.split(";")[0])[0] == "!") {
                                                    filter += filter_item.split(";")[0].replace("!", "") + "=2";
                                                } else {
                                                    filter += filter_item.split(";")[0] + "=1";
                                                }
                                                filter += "~";
                                                for (var j = 1; j < filter_item.split(";").length; j++) {
                                                    if (Array.from(filter_item.split(";")[j])[0] == "!") {
                                                        filter += filter_item.split(";")[j].replace("!", "") + "=2";
                                                    } else {
                                                        filter += filter_item.split(";")[j] + "=1";
                                                    }
                                                }
                                            } else {
                                                if (Array.from(filter_item)[0] == "!") {
                                                    filter += filter_item.replace("!", "") + "=2";
                                                } else {
                                                    filter += filter_item + "=1";
                                                }
                                            }
                                        }
                                    }

                                    result = result.replace(match[0], "<a target=\"_blank\" href=\"https://5e.tools/" + page + ".html#blankhash" + filter + "\">" + text + "</a>");
                                    break;
                            }
                        });
                    }
                } else if (typeof str == "object") {
                    if (str.type == "abilityDc") {
                        return "";
                    } else if (str.type == "abilityAttackMod") {
                        return "";
                    } else if (str.type == "list") {
                        result = "<ul>";
                        str.items.forEach(entry => {
                            result += "<li>" + render(entry) + "</li>";
                        });
                        result += "</ul>";
                    } else if (str.type == "table") {
                        result = "<table>\n<tr>\n";
                        str.colLabels.forEach(header => {
                            result += "<th>" + render(header) + "</th>";
                        });
                        result += "</tr>";
                        str.rows.forEach(row => {
                            result += "<tr>";
                            row.forEach(item => {
                                result += "<td>" + render(item) + "</td>";
                            });
                            result += "</tr>";
                        });
                        result += "</table>";
                    } else if (str.type == "entries") {
                        result = "<strong>" + result.name + "</strong>\n";
                        str.entries.forEach(entry => {
                            result += "<p>" + render(entry) + "</p>";
                        });
                    }
                }
                return result;
            }

            async function getRace(id) {
                var data = await getData("https://5e.tools/data/races.json");
                var result = {};

                var race = data["race"].find((o) => o.name + "_" + o.source == id);
                if (race != undefined) {
                    result = {
                        abilities:  race.ability,
                        entries:    race.entries,
                        full_name:  race.name,
                        id:         id,
                        name:       race.name,
                        parent:     "",
                        source:     race.source,
                        sub_name:   "",
                        subraces:   []
                    }
                } else {
                    race = data["subrace"].find((o) => o.raceName + "_" + o.raceSource + "_" + o.name + "_" + o.source == id);
                    result = {
                        abilities:  race.ability,
                        entries:    race.entries,
                        full_name:  race.raceName + " (" + race.name + ")",
                        id:         id,
                        name:       race.raceName,
                        parent:     race.raceName + "_" + race.raceSource,
                        source:     race.source,
                        sub_name:   race.name,
                        subraces:   []
                    };
                }

                return result;
            }

            async function get_race_list() {
                var data = await getData("https://5e.tools/data/races.json");

                var id = "";
                var str = "";

                var element = document.getElementById("race_container");

                for (var i = 0; i < data["race"].length; i++) {
                    id = data["race"][i].name + "_" + data["race"][i].source;

                    races[id] = {
                        full_name:  data["race"][i].name,
                        id:         id,
                        parent:     "",
                        source:     data["race"][i].source,
                        subraces:   [],
                    };
                    race_ids.push(id);
                }
                for (var i = 0; i < data["subrace"].length; i++) {
                    if (data["subrace"][i].name != undefined) {
                        id = data["subrace"][i].raceName + "_" + data["subrace"][i].raceSource + "_" + data["subrace"][i].name + "_" + data["subrace"][i].source;
                        races[id] = {
                            full_name:  data["subrace"][i].raceName + " (" + data["subrace"][i].name + ")",
                            id:         id,
                            parent:     data["subrace"][i].raceName + "_" + data["subrace"][i].raceSource,
                            source:     data["subrace"][i].source,
                            subraces:   [],
                        };
                        races[data["subrace"][i].raceName + "_" + data["subrace"][i].raceSource].subraces.push(id);
                        race_ids.push(id);
                    }
                }

                str = "";
                for (const [id, race] of Object.entries(races)) {
                    if (race.parent == "") {
                        str += "<li id=\"" + race.id + "\"><p>";
                        str += race.full_name + "<span class=\"source " + race.source + "\">[" + race.source + "]</span>";
                        str += "</p></li>\n";
                        for (var i = 0; i < race.subraces.length; i++) {
                            str += "<li id=\"" + races[race.subraces[i]].id + "\" class=\"sub\"><p>";
                            str += races[race.subraces[i]].full_name + "<span class=\"source " + races[race.subraces[i]].source + "\">[" + races[race.subraces[i]].source + "]</span>";
                            str += "</p></li>\n";
                        }
                    }
                }
                races = {};
                document.getElementById("race_list").innerHTML += str;
                //update_dropdowns();
            }

            async function get_class_list() {
                var data = await getData("https://5e.tools/data/class/index.json");
                
                var str = "";
                for (const [id, class_string] of Object.entries(data)) {
                    var class_struct = await getData(`https://5e.tools/data/class/${class_string}`);
                    str += "<li id=\"" + class_struct.class[0].name + "_" + class_struct.class[0].source + "\"><p>";
                    str += class_struct.class[0].name + "<span class=\"source " + class_struct.class[0].source + "\">[";
                    str += class_struct.class[0].source + "]</span>";
                    str += "</p></li>\n";
                }
                
                for (var i = 1; i <= class_num; i++) {
                    document.getElementById(`class${i}_list`).innerHTML = str;
                }
            }

            async function get_class_sub_list() {
                var data = await getData("https://5e.tools/data/class/index.json");
                var class_struct = await getData(`https://5e.tools/data/class/${data[character_class.toLowerCase()]}`);

                var str = "";
                class_struct["subclass"].forEach(subclass => {
                    var id = class_struct.class[0].name + "_" + class_struct.class[0].source + "_" + subclass.shortName + "_" + subclass.source;
                    str += "<li id=\"" + id + "\"><p>";
                    str += subclass.name + "<span class=\"source " + subclass.source + "\">[";
                    str += subclass.source + "]</span>";
                    str += "</p></li>\n";
                });

                for (var i = 1; i <= class_num; i++) {
                    document.getElementById(`class${i}_sub_list`).innerHTML = str;
                }
            }

            function get_class_level_list() {
                var str = `<li id="1">1</li>
                                    <li id="2">2</li>
                                    <li id="3">3</li>
                                    <li id="4">4</li>
                                    <li id="5">5</li>
                                    <li id="6">6</li>
                                    <li id="7">7</li>
                                    <li id="8">8</li>
                                    <li id="9">9</li>
                                    <li id="10">10</li>
                                    <li id="11">11</li>
                                    <li id="12">12</li>
                                    <li id="13">13</li>
                                    <li id="14">14</li>
                                    <li id="15">15</li>
                                    <li id="16">16</li>
                                    <li id="17">17</li>
                                    <li id="18">18</li>
                                    <li id="19">19</li>
                                    <li id="20">20</li>`;

                for (var i = 1; i <= class_num; i++) {
                    document.getElementById(`class${i}_level_list`).innerHTML = str;
                }
            }

            async function get_background_list() {
                var data = await getData("https://5e.tools/data/backgrounds.json");

                var str = "";
                var id = "";
                for (const background of data.background) {
                    id = background.name + "_" + background.source;
                    str += "<li id=\"" + id + "\"><p>";
                    str += background.name + "<span class=\"source " + background.source + "\">[" + background.source + "]</span>";
                    str += "</p></li>\n";
                }
                document.getElementById("background_list").innerHTML += str;
                update_dropdowns();
            }

            function get_alignment_list() {
                var str = `<li id="Lawful_Good">Lawful Good</li>
                                    <li id="Lawful_Neutral">Lawful Neutral</li>
                                    <li id="Lawful_Evil">Lawful Evil</li>
                                    <li id="Neutral_Good">Neutral Good</li>
                                    <li id="True_Neutral">True Neutral</li>
                                    <li id="Neutral_Evil">Neutral Evil</li>
                                    <li id="Chaotic_Good">Chaotic Good</li>
                                    <li id="Chaotic_Neutral">Chaotic Neutral</li>
                                    <li id="Chaotic_Evil">Chaotic Evil</li>`;

                document.getElementById(`alignment_list`).innerHTML = str;
            }

            async function add_class() {
                class_num += 1;
                var str = `<tr>
                            <td colspan="6">
                                <input type="text"      id="class${class_num}"         name="class${class_num}"       value="" placeholder="Class"
                                    class="chosen-value">
                                <ul class="value-list"  id="class${class_num}_list"></ul>
                                <label>Class</label>
                            </td>
                            <td colspan="6">
                                <input type="text"      id="class${class_num}_sub"     name="class${class_num}_sub"   value="" placeholder="Subclass"
                                    class="chosen-value">
                                <ul class="value-list"  id="class${class_num}_sub_list"></ul>
                                <label>Subclass</label>
                            </td>
                            <td colspan="2">
                                <input type="text"      id="class${class_num}_level"   name="class${class_num}_level" value="" placeholder="Level"
                                    class="chosen-value">
                                <ul class="value-list"  id="class${class_num}_level_list"></ul>
                                <label>Level</label>
                            </td>
                            <td colspan="2">
                                <input type="text"      id="class${class_num}_exp"     name="class${class_num}_exp"       placeholder="XP">
                                <label>Experience Points</label>
                            </td>
                        </tr>
                        <tr id="class_control">
                            <td colspan="10"></td>
                            <td colspan="3"><input type="button"    id="add_class"      value="Add Class"/></td>
                            <td colspan="3"><input type="button"    id="remove_class"   value="Remove Class"/></td>
                        </tr>`;

                var element = document.getElementById("class_control");
                element.parentNode.removeChild(element);

                document.getElementById("class_list").children[0].children[0].innerHTML += str;
                document.getElementById("add_class").addEventListener("click", add_class);
                document.getElementById("remove_class").addEventListener("click", remove_class);
                
                update_dropdowns();
            }

            async function get_class(id) {
                var data = await getData("https://5e.tools/data/class/index.json");
                var class_struct = await getData(`https://5e.tools/data/class/${data[id.split("_")[0].toLowerCase()]}`);
                /*for (const [id, class_string] of Object.entries(data)) {
                    var class_struct = await getData(`https://5e.tools/data/class/${class_string}`);
                }
                
                for (var i = 1; i <= class_num; i++) {
                    document.getElementById(`class${i}_list`).innerHTML = str;
                }*/
               console.log(class_struct);
               return class_struct;
            }

            function remove_class() {
                class_num -= 1;
                var index = document.getElementById("class_list").children[0].children[0].children.length - 2;

                var element = document.getElementById("class_list").children[0].children[0].children[index];
                element.parentNode.removeChild(element);
            }

            function hide_races() {
                race_ids.forEach(race => {
                    var elements = [...document.getElementsByClassName(race)];
                    elements.forEach(element => {
                        element.classList.remove("hidden");
                        element.classList.add("hidden");
                    });
                });
            }

            function dropdown_on_input(event) {
                const input = event.currentTarget;
                const dropdown = document.getElementById(input.name + "_list");
                const dropdownArray = [...dropdown.children];

                let valueArray = [];
                dropdownArray.forEach(item => {
                    valueArray.push(item.textContent);
                });

                dropdown.classList.add('open');
                let inputValue = input.value.toLowerCase();
                let valueSubstring;
                if (inputValue.length > 0) {
                    for (let j = 0; j < valueArray.length; j++) {
                        if (!(inputValue.substring(0, inputValue.length) === valueArray[j].substring(0, inputValue.length).toLowerCase())) {
                            dropdownArray[j].classList.add('closed');
                        } else {
                            dropdownArray[j].classList.remove('closed');
                        }
                    }
                } else {
                    for (let i = 0; i < dropdownArray.length; i++) {
                        dropdownArray[i].classList.remove('closed');
                    }
                }
            }

            async function dropdown_on_click(event) {
                const input_field = event.currentTarget.parentNode.parentNode.children[0];
                const dropdown = event.currentTarget.parentNode;
                const selected_id = event.currentTarget.id;

                switch (input_field.name) {
                    case "race":
                        character_race = await getRace(selected_id);
                        const race = character_race;

                        input_field.value = race.full_name;

                        var str = "";
                        if (race.parent != "") {
                            const parent_race = await getRace(race.parent);
                            for (var i = 0; i < parent_race.entries.length; i++) {
                                str += "<p><strong>" + parent_race.entries[i].name + ".</strong>";
                                str += " " + render(parent_race.entries[i].entries[0]);
                                for (var j = 1; j < parent_race.entries[i].entries.length; j++) {
                                    str += "</p><p>" + render(parent_race.entries[i].entries[j]);
                                }
                                str += "</p>";
                            }
                        }
                        for (var i = 0; i < race.entries.length; i++) {
                            str += "<p><strong>" + race.entries[i].name + ".</strong>";
                            str += " " + render(race.entries[i].entries[0]);
                            for (var j = 1; j < race.entries[i].entries.length; j++) {
                                str += "</p><p>" + render(race.entries[i].entries[j]);
                            }
                            str += "</p>";
                        }
                        document.getElementById("race_traits").innerHTML = "<h3>Racial Traits</h3>" + str;
                        break;

                    case "class1":
                    case "class2":
                    case "class3":
                    case "class4":
                    case "class5":
                    case "class6":
                        var class_struct = await get_class(selected_id);
                        character_class = class_struct.class[0].name;
                        input_field.value = class_struct.class[0].name;

                        var str = "";
                        var id = "";
                        class_struct.subclass.forEach(subclass => {
                            id = class_struct.class[0].name + "_" + class_struct.class[0].source + "_" + subclass.shortName + "_" + subclass.source;
                            str += "<li id=\"" + id + "\">" + subclass.name + "</li>";
                        });
                        document.getElementById(input_field.name + "_sub_list").innerHTML = str;

                        str = "";
                        var class_features = class_struct["class"][0]["classFeatures"];
                        var class_feature_fluff = class_struct["classFeature"];
                        var prev_level = 0;

                        for (var i = 0; i < class_features.length; i++) {
                            var feature = "";
                            if (typeof class_features[i] == "string") {
                                feature = class_feature_fluff.find((o) => o.name == class_features[i].split("|")[0] && o.level == class_features[i].split("|")[3]);
                            } else {
                                feature = class_feature_fluff.find((o) => o.name == class_features[i]["classFeature"].split("|")[0] && o.level == class_features[i]["classFeature"].split("|")[3]);
                            }
                            if (feature.level != prev_level) {
                                if (prev_level != 0) {
                                    str += "</div>";
                                }
                                str += "<input type=\"button\" id=\"Level_" + feature.level + "\" class=\"collapsible\" value=\"Level " + feature.level + "\" />";
                                prev_level = feature.level;
                                str += "<div class=\"content hidden\">";
                            }
                            str += "<input type=\"button\" id=\"" + feature.name + "_" + feature.level + "\" class=\"collapsible\" value=\"" + feature.name + "\" />";
                            str += "<div class=\"content hidden\">";
                                str += "<p>" + render(feature.entries[0]);
                                for (var j = 1; j < feature.entries.length; j++) {
                                    str += "</p><p>" + render(feature.entries[j]);
                                }
                                str += "</p>";
                            str += "</div>";
                        }
                        document.getElementById("class_traits").innerHTML = "<h3>Class Features</h3>" + str;
                        update_collapsibles();
                        break;
                    
                    case "class1_sub":
                    case "class2_sub":
                    case "class3_sub":
                    case "class4_sub":
                    case "class5_sub":
                    case "class6_sub":
                        var class_id = selected_id.split("_")[0] + "_" + selected_id.split("_")[1];
                        var class_struct = await get_class(class_id);
                        input_field.value = class_struct.subclass.find((o) => o.shortName == selected_id.split("_")[2]).name;

                        console.log(input_field.value);

                        var str = "";
                        var class_features = class_struct.subclass.find((o) => o.shortName == selected_id.split("_")[2])["subclassFeatures"];
                        var class_feature_fluff = class_struct["subclassFeature"];
                        var prev_level = 0;

                        console.log(class_features);
                        for (var i = 0; i < class_features.length; i++) {
                            var feature = "";
                            str = "";
                            if (typeof class_features[i] == "string") {
                                feature = class_feature_fluff.find((o) => o.name == class_features[i].split("|")[0] && o.level == class_features[i].split("|")[5]);
                            } else {
                                feature = class_feature_fluff.find((o) => o.name == class_features[i]["subclassFeature"].split("|")[0] && o.level == class_features[i]["classFeature"].split("|")[5]);
                            }
                            str += "<input type=\"button\" id=\"" + feature.name + "_" + feature.level + "\" class=\"collapsible\" value=\"" + feature.name + "\" />";
                            str += "<div class=\"content hidden\">";
                                str += "<p>" + render(feature.entries[0]);
                                for (var j = 1; j < feature.entries.length; j++) {
                                    str += "</p><p>" + render(feature.entries[j]);
                                }
                                str += "</p>";
                            str += "</div>";
                            var element = document.getElementById("Level_" + feature.level).nextElementSibling;
                            if (element.children.length > 0) {
                                element.children[element.children.length - 1].innerHTML += str;
                            } else {
                                element.innerHTML += str;
                            }
                        }
                        update_collapsibles();
                        break;

                    default:
                        var str = document.getElementById(selected_id).children[0].cloneNode(true);
                        str.removeChild(str.children[0]);
                        console.log(str);
                        input_field.value = str.innerText;
                        break;
                }

                dropdown.innerHTML = "";
            }

            async function update_dropdown(name) {
                var function_name = "get_" + name + "_list";
                if (name.includes("class")) {
                    function_name = "get_class" + name.slice(6) + "_list";
                }
                console.log(function_name);
                if (typeof window[function_name] == "function") {
                    await window[function_name]();
                }

                const input_field = document.getElementById(name);
                const dropdown = document.getElementById(name + "_list");

                const dropdownArray = [...dropdown.children];
                dropdown.classList.add('closed');

                dropdownArray.forEach(item => {
                    item.addEventListener('click', dropdown_on_click);
                });
            }

            function update_dropdowns() {
                var i = 0;
                const inputFields = document.getElementsByClassName("chosen-value");
                const dropdowns = document.getElementsByClassName("value-list");

                for (let inputField of inputFields) {
                    let dropdown = dropdowns[i];

                    const dropdownArray = [...dropdown.children];
                    dropdown.classList.add('closed');

                    inputField.addEventListener('input', dropdown_on_input);

                    inputField.addEventListener('focus', (event) => {
                        update_dropdown(event.target.name);
                        dropdown.classList.add('open');
                    });

                    inputField.addEventListener('blur', () => {
                        dropdown.classList.remove('open');
                    });

                    document.addEventListener('click', (evt) => {
                        const isDropdown = dropdown.contains(evt.target);
                        const isInput = inputField.contains(evt.target);
                        if (!isDropdown && !isInput) {
                            dropdown.innerHTML = "";
                            dropdown.classList.remove('open');
                        }
                    });
                    i += 1;
                };
            }

            function collapsible_on_click(event) {
                const content = event.currentTarget.nextElementSibling;
                content.classList.toggle("hidden");
            }

            function update_collapsible(name) {
                if (typeof name == "string") {
                    document.getElementById(name).addEventListener("click", collapsible_on_click);
                } else {
                    name.addEventListener("click", collapsible_on_click);
                }
            }

            function update_collapsibles() {
                var coll = document.getElementsByClassName("collapsible");
                var i;

                for (i = 0; i < coll.length; i++) {
                    update_collapsible(coll[i]);
                }
            }

            async function init() {
                //getRaces();
                //get_classes();
                //get_backgrounds();
                update_dropdowns();
                update_collapsibles();
            }

            window.onload = init();
            document.getElementById("add_class").addEventListener("click", add_class);
            document.getElementById("remove_class").addEventListener("click", remove_class);
        </script>
    </body>
</html>